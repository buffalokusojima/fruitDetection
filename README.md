# fruitDetection

# 課題について

各種フルーツの画像からその種類、品種を学習したモデルを作成し、それを用いてフルーツの種類、品種を判定する。

## 環境

Python

- Python 3.6.8

- モジュール: requirements.txtをインストール `pip install -r requirements.txt`

モデル

下記URLからモデルをダウンロードし、program/model_data内に配置
- https://oshonkoponpon.s3.ap-northeast-1.amazonaws.com/%E7%A8%AE%E9%A1%9E%E3%83%A2%E3%83%86%E3%82%99%E3%83%AB.zip
- https://oshonkoponpon.s3.ap-northeast-1.amazonaws.com/%E5%93%81%E7%A8%AE%E3%83%A2%E3%83%86%E3%82%99%E3%83%AB.zip 

下記URLからモデルをダウンロードし、document/アノテーションの効果に配置
- https://oshonkoponpon.s3.ap-northeast-1.amazonaws.com/%E3%82%A2%E3%83%8E%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%8A%B9%E6%9E%9C%E3%83%A2%E3%83%86%E3%82%99%E3%83%AB.zip

データ
下記URLからデータをダウンロードし、data内に配置
- https://oshonkoponpon.s3.ap-northeast-1.amazonaws.com/%E5%AD%A6%E7%BF%92%E3%83%86%E3%82%B9%E3%83%88%E3%83%86%E3%82%99%E3%83%BC%E3%82%BF.zip

## 課題実行方法

課題実行方法について記載する

詳細は課題実行フォルダ内のスクリプトに記載されている。
コマンドから実行する場合は以下を実行

`python detect.py ../../data/image_data ../../data/bbox_data.csv ../../data/label_info.csv ../../data/result`

jupyterファイルに各種操作が記載されているので見る際は、下記コマンドでwebサーバーを立てる

`jupyter notebook` \
`localhost:8080`にアクセスしてjupyterファイルを開く

### 概要

起動時に種類判別モデル、種類判別モデルのネットワーク展開を行う。
その後、対象のフォルダを読み込み、画像１枚ずつに対して種類判定を行い、出力された種類を
元に該当する品種モデルで判別を行いその結果を事務局が提示するラベルに照らし合わせてリストに格納する。
最終的にリストの内容をCSVファイルに書き出す。


## 学習運用方法

- 学習に必要なもの

  - 画像データファイル
  - 画像データに対するアノテーションファイル
  - 分類を行う為のクラスファイル
  - 学習を行う為のパラメータファイル
  - 学習に使用する初期モデルファイル

- 学習結果として残すもの

  - 学習する際に作成した学習リスト(どの画像を使用したかパスとアノテーションが記載されたファイル)
  - 学習の際に作成したクラスファイル(どういった分類を行ったか)
  - 学習した結果作成されたモデルファイル(複数)
  - 学習の推移が描かれた画像ファイル

- 運用方法

  学習スクリプトを起動することで基本的に自動的にアウトプットフォルダが作成されてそこに学習結果が作成される
  スクリプトを起動する際に変更する点としては以下

  - 学習データのパス(画像ファイルとアノテーションファイルが格納されたパス)
  - 学習結果パス(logs/モデル名/データの種類(使用するデータのパスの名前など))

  この際、作成されるクラスファイルは学習データのパス直下にあるフォルダの名前になる。

  (例)種類モデルの場合

      学習データのパスが"学習データ/479削除データ(アノテーションテスト・keras-yolo3)/種類/image"の場合

      このフォルダ構成は以下のようになっている

      image ----------1_リンゴ
             |
                 |----2_梨


      annotation -----1_リンゴ
                  |
                  |---2_梨

      よって、image直下のリンゴ、梨、、、がクラスとなったクラスファイルが作成される。

    
    
  ※学習の処理がサーバリソースに多大なる影響を及ぼす為、本環境で学習は行わない。\
  あくまで今後の知見等に活かすため運用方法を記載したまでである。\
  学習は個々端末で実施(GPU推奨)
  
  
### 使用するスクリプト
programフォルダ内の学習フォルダ内にあるスクリプトを実行することで上記で説明した用に動作する。
また、このスクリプトを動作するに当たって必要なインプットとしては学習リストのパスをまとめたファイルが
必要となる。詳細はスクリプトを参照であるが、動作としては読み込んだ学習リストから種類か品種を判断し、
アウトプットとなるフォルダ作成や必要なクラスファイル取得等を行い、ファイルの行数分学習を行う。


## テスト運用方法

- テストに必要なもの

  - 学習済のモデルファイル
  - モデルに対するクラスファイル
  - 学習を行う為のパラメータファイル
  - テストする画像パスが記載されたテストファイル

- テストの結果として残すもの

  - 使用したモデルファイル
  - 使用したテストファイル
  - 正答率等をまとめたファイル
  - 正誤表
  - 不正解だった画像とそのアノテーションファイル
  - スクリプト自体をhtmlファイルにしたファイル

- 運用方法

  学習済のモデルファイルパスを元にアウトプットパスが生成される。

  前提として使用されるテストデータは事務局が用意したデータから種類ごとに100枚、
  品種ごとに30枚ずつ抽出したものである。
  学習に使用したデータはネットから独自に収集したものであり、いくつかはテストデータに
  存在するものであるが、基本的に未知のデータとして扱う。

  テストファイルには学習時と同様に画像パス以外に、アノテーションとクラス情報が格納されている。
  よって、テストの観点としては、画像認識をした際に出力されるアノテーションと、テストファイルに
  記載されているアノテーションを比較し、認識したアノテーションの中で最も近いもののクラスを認識結果とし、
  テストファイルに記載されているクラスと比較し、正答率を得る。

  対象のスクリプトはテストにあるテストレポート実行である。
  アノテーション認識について記載されてるスクリプトとしてはモデル精度検査_v3.htmlがある。

- テストデータ作成

  - 画像データから種類と品種に関して③で示した数の画像をランダムに取得し、新たにテストデータとしてコピーする(テストデータ作成スクリプト各種)
 
  - 新たに作成したテストフォルダに関して、情報を１つにまとめたテストファイルを作成する(テストリスト作成スクリプト)

## データ操作説明

programのデータ操作フォルダ内に各種プログラムが格納されている

- Augmentation各種

  画像データに対して水増しを行うスクリプト。１枚の画像に対して複数の水増し処理が可能。
  フォルダに対して全ての画像に対して処理を実行して運用。
  アノテーションに影響する処理にも対応し、アノテーションファイルも新たに作成される。
  (例)
  左右反転であれば、アノテーションも左右反転される


- PascalVocをkeras-yolo3用フォーマットに変換

  アノテーションツールであるlabelImgを使用すると出力されるフォーマットはxmlである。
  今回のアルゴリズムで必要なフォーマットはtxtである。そのフォーマットの変換を行うスクリプト。
  フォルダに対して該当するxmlを全てtxtに変換して運用。


- YOLO形式を見つけるスクリプト

  アノテーション運用を続けているとアノテーションをしていないファイルや形式の異なるファイルを
  作成してしまたケースがあった。その際、それらで学習リストを作成し、学習を行うとフォーマットの
  相違でエラーとなってしまう。それを事前に回避する為に本スクリプトで対象のフォルダ内のtxtファイル
  のフォーマットを確認する。


- アノテーションtxtをxml形式に変換する

  アノテーションサポートによって出力されたtxtファイルを元にアノテーションツールでアノテーションを修正する為に、フォーマットをxml形式に変換するスクリプト。

- アノテーションの数比較

  該当のフォルダのアノテーションの数を表示するスクリプト。

- 品種のラベルを種類に変換(逆もしかり)

  アノテーションファイルのラベルを品種から種類に変換する。(逆もしかり)
  
## アノテーションサポート説明

プログラムはprogamのアノテーションサポートフォルダに格納されている。
アノテーション作業をするに当たって、事前に事務局のデータを元に種類判別モデルを作成し、
そのモデルで自身で収集した画像の判別を行う。その結果を該当のフォルダにアノテーションファイル
として出力するスクリプト。
その後、データ操作内のxml変換スクリプトを用いてxmlファイル形式に変換し、アノテーションツールで
開けるようにする。

## アノテーションツール

https://github.com/tzutalin/labelImg


## 採用アルゴリズム

- YOLO

  以下、各種参照

  製作者URL
  https://pjreddie.com/darknet/yolo/

  アルゴリズムの説明(日本語)
  https://dev.classmethod.jp/articles/research_paper_yolo/


- 採用理由

  元々、案件で使用していた経歴があり、導入手順やアルゴリズム等は把握していた為。
  また、アルゴリズムと言っても基本はCNN１本でその中で分類とアノテーションの判定を同時に
  行っている点から実務向と判断。実際に弊社実務にも取り入れられた実績がある。
  実務では口座振替読み込みで画像の色合いというよりかは、口座名義人や口座番号がどこかを枠の形で
  判定していた。というのも、カラーの画像よりかは白黒コピーの画像が多かった為である。
  口座振替では学習画像として6000枚を使用し、精度としてはmAPで80%程度(分類数は30前後)を参考にし、
  本課題の学習枚数も、１モデル当たり6000枚は超えるよう、収集、水増しを行った。
